<!DOCTYPE html>
<html>
<head>
    <title>Example 01.01 - Basic skeleton</title>
    <script type="text/javascript" src="./libs/three.js"></script>
    <script type="text/javascript" src="./libs/stats.js"></script>
    <script type="text/javascript" src="./libs/dat.gui.js"></script>
    <script type="text/javascript" src="./libs/TrackballControls.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
    </style>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div id="WebGL-output"></div>
    <div id="Stats-output"></div>
    <div id="info"></div>
    
    <script type="text/javascript">
        // global variables
        var renderer;
        var scene;
        var camera;
        var stats
        var clock;
        var trackballControls;
        var joint;
        var plane;

        var controls = new function() {
            // plane
            this.planeWidth = 50;
            this.planeLong = 50;

            // joint
            this.jointSize = 0.1;

            // camera
            this.rotateSpeed = 1.0;
            this.zoomSpeed = 10.0;
            this.panSpeed = 1.0;
        }

        function init() {
            clock = new THREE.Clock();

            stats = initStats();
            
            // create a scene, that will hold all our elements such as objects, cameras and lights.
            scene = new THREE.Scene();

            // create a camera, which defines where we're looking at.
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);

            camera.up.set(0,0,1);

            trackballControls = new THREE.TrackballControls(camera);
            trackballControls.rotateSpeed = controls.rotateSpeed;
            trackballControls.zoomSpeed = controls.zoomSpeed;
            trackballControls.panSpeed = controls.panSpeed;
            trackballControls.staticMoving = true;

            // position and point the camera to the center of the scene
            camera.position.x = -30;
            camera.position.y = 40;
            camera.position.z = 30;
            camera.lookAt(scene.position);

            // create a render and set the size
            renderer = new THREE.WebGLRenderer();
            renderer.setClearColor(new THREE.Color(0xEEEEEE));
            renderer.setSize(window.innerWidth, window.innerHeight);

            // show axes in the screen
            var axes = new THREE.AxisHelper(20);
            scene.add(axes);

            // create the ground plane
            var planeGeometry = new THREE.PlaneGeometry(controls.planeWidth, controls.planeLong);
            var planeMaterial = new THREE.MeshBasicMaterial({color: 0xcccccc});
            plane = new THREE.Mesh(planeGeometry, planeMaterial);

            // rotate and position the plane
            // plane.rotation.x = -0.5 * Math.PI;
            // plane.position.x = 15;
            // plane.position.y = 0;
            // plane.position.z = 0;

            // add the plane to the scene
            scene.add(plane);

            // add joints
            joint = new Joint();
            scene.add(joint);

            // controls
            var gui = new dat.GUI();
            gui.add(controls, 'jointSize', 0.1, 1);
            gui.add(controls, 'rotateSpeed', 0, 1);
            gui.add(controls, 'zoomSpeed', 0, 1);
            gui.add(controls, 'panSpeed', 0, 1);

            // add the output of the renderer to the html element
            document.getElementById("WebGL-output").appendChild(renderer.domElement);
            
            // setupKeyLogger();
            setupKeyControls();

            // render the scene
            render();
        }

        function showInfo() {
            var info = [];

            // plane
            info.push("plane [l]ong: " + controls.planeLong.toFixed(2));
            info.push("plane [w]idth: " + controls.planeWidth.toFixed(2));

            // joint
            info.push("[j]ointSize: " + controls.jointSize.toFixed(2));

            // camera
            info.push("[r]otateSpeed: " + controls.rotateSpeed.toFixed(2));
            info.push("[z]oomSpeed: " + controls.zoomSpeed.toFixed(2));
            info.push("[p]anSpeed: " + controls.panSpeed.toFixed(2));
            
            var infoString = '';
            for (i = 0; i < info.length; i++) {
                infoString += info[i] + '\n';
            }

            document.getElementById("info").innerHTML = infoString;
        }
        
        function setupKeyControls() {
            var map = {};

            document.onkeydown = document.onkeyup = function (e) {
                e = e || event;
                map[e.keyCode] = e.type == 'keydown';

                // plane
                if (map[76] && (map[107] || map[171])) { // l + '+'
                    controls.planeLong += 1;
                }
                if (map[76] && (map[109] || map[173])) { // l + '+'
                    controls.planeLong -= 1;
                }
                
                if (map[87] && (map[107] || map[171])) { // w + '+'
                    controls.planeWidth += 1;
                }
                if (map[87] && (map[109] || map[173])) { // w + '+'
                    controls.planeWidth -= 1;
                }

                // jointSize
                if (map[74] && (map[107] || map[171])) { // j + '+'
                    controls.jointSize += 0.1;
                }
                if (map[74] && (map[109] || map[173])) { // j + '-'
                    controls.jointSize -= 0.1;
                }

                // rotateSpeed
                if (map[82] && (map[107] || map[171])) { // r + '+'
                    controls.rotateSpeed += 0.1;
                }
                if (map[82] && (map[109] || map[173])) { // r + '-'
                    controls.rotateSpeed -= 0.1;
                }

                if (map[90] && (map[107] || map[171])) { // z + '+'
                    controls.zoomSpeed += 0.1;
                }
                if (map[90] && (map[109] || map[173])) { // z + '-'
                    controls.zoomSpeed -= 0.1;
                }

                if (map[80] && (map[107] || map[171])) { // p + '+'
                    controls.panSpeed += 0.1;
                }
                if (map[80] && (map[109] || map[173])) { // p + '-'
                    controls.panSpeed -= 0.1;
                }
            };

        }

        function Joint() {
            this.type = "Joint";
            
            this.geometry = new THREE.SphereGeometry(5);
            this.material = new THREE.MeshBasicMaterial({color: 0xff0000});
            
            THREE.Mesh.call(this, this.geometry, this.material);
        }
        
        Joint.prototype = Object.create(THREE.Mesh.prototype);
        Joint.prototype.constructor = Joint;
        
        Joint.prototype.getMesh = function() {
            return this.mesh;
        }
        
        function render() {
            // show info
            showInfo();

            // update the camera
            var delta = clock.getDelta();
            trackballControls.update(delta)
            trackballControls.rotateSpeed = controls.rotateSpeed;
            trackballControls.zoomSpeed = controls.zoomSpeed;
            trackballControls.panSpeed = controls.panSpeed;
            
            // update the statistics
            stats.update();
            
            // update the joint
            joint.geometry = new THREE.SphereGeometry(controls.jointSize);

            // update the plane
            plane.geometry = new THREE.PlaneGeometry(controls.planeLong, controls.planeWidth);

            // update the scene
            requestAnimationFrame(render);
            renderer.render(scene, camera);
        }
        
        function initStats() {
            var stats = new Stats();
            
            stats.setMode(0);
            
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.left = '0px';
            stats.domElement.style.top = '0px';
            document.getElementById("Stats-output").appendChild(stats.domElement);

            return stats;
        }

        window.onload = init
    </script>
</body>
</html>